/*! bebella 2016-07-16 */
function view(a){return APP_URL+"/channel/"+a}function api_v1(a,b){return APP_URL+"/api/v1/"+a+"?api_token="+API_TOKEN}function attr(a,b){for(var c in b)"created_at"==c||"updated_at"==c?a[c]=new Date(b[c]):c.startsWith("has_")||c.startsWith("is_")||c.startsWith("used_for_")||"active"==c?a[c]=1==b[c]:a[c]=b[c]}var Bebella=angular.module("Bebella",["ui.router","datatables","angular-flot","ngStorage"]),APP_URL=$("#APP_URL").val(),API_TOKEN=$("#API_TOKEN").val();Bebella.run([function(){}]),Bebella.factory("Product",[function(){var a=new Function;return a}]),Bebella.factory("Recipe",[function(){var a=function(){this.tags=new Array,this.steps=new Array,this.products=new Array,this.comments=new Array,this.related=new Array};return a}]),Bebella.service("CurrentRecipe",["$q","$localStorage","Recipe",function(a,b,c){var d=this;d.get=function(){return b.current_recipe||(b.current_recipe=new c),b.current_recipe},d.clear=function(){b.current_recipe=new c}}]),Bebella.service("ProductRepository",["$http","$q","Product",function(a,b,c){var d=this;d.find=function(d){var e=b.defer();return a.get(api_v1("product/find/"+d)).then(function(a){var b=new c;attr(b,a.data),e.resolve(b)},function(a){e.reject(a)}),e.promise},d.groupByCategory=function(){var d=b.defer();return a.get(api_v1("product/groupByCategory")).then(function(a){var b=_.map(a.data,function(a){var b=_.map(a,function(a){var b=new c;return attr(b,a),b});return b});d.resolve(b)},function(a){d.reject(a)}),d.promise},d.all=function(){var d=b.defer();return a.get(api_v1("product/all")).then(function(a){var b=_.map(a.data,function(a){var b=new c;return attr(b,a),b});d.resolve(b)},function(a){d.reject(a)}),d.promise},d.edit=function(c){var d=b.defer(),e=JSON.stringify(c);return a.post(api_v1("product/edit"),e).then(function(a){d.resolve(c)},function(a){d.reject(a)}),d.promise},d.save=function(c){var d=b.defer(),e=JSON.stringify(c);return a.post(api_v1("product/save"),e).then(function(a){c.id=a.data.id,d.resolve(c)},function(a){d.reject(a)}),d.promise}}]),Bebella.service("RecipeRepository",["$http","$q","Recipe",function(a,b,c){var d=this;d.find=function(d){var e=b.defer();return a.get(api_v1("recipe/find/"+d)).then(function(a){var b=new c;attr(b,a.data),e.resolve(b)},function(a){e.reject(a)}),e.promise},d.all=function(){var d=b.defer();return a.get(api_v1("recipe/all")).then(function(a){var b=_.map(a.data,function(a){var b=new c;return attr(b,a),b});d.resolve(b)},function(a){d.reject(a)}),d.promise},d.edit=function(c){var d=b.defer(),e=JSON.stringify(c);return a.post(api_v1("recipe/edit"),e).then(function(a){d.resolve(c)},function(a){d.reject(a)}),d.promise},d.save=function(c){var d=b.defer(),e=JSON.stringify(c);return a.post(api_v1("recipe/save"),e).then(function(a){c.id=a.data.id,d.resolve(c)},function(a){d.reject(a)}),d.promise},d.sendForApproval=function(c){var d=b.defer(),e=JSON.stringify(c);return a.post(api_v1("recipe/sendForApproval"),e).then(function(a){c.id=a.data.id,d.resolve(c)},function(a){d.reject(a)}),d.promise}}]),Bebella.controller("ProfileIndexCtrl",["$scope",function(a){}]),Bebella.controller("StatsIndexCtrl",["$scope",function(a){}]),Bebella.controller("HomeIndexCtrl",["$scope",function(a){}]),Bebella.controller("RecipeListCtrl",["$scope",function(a){}]),Bebella.controller("RecipeNewCtrl",["$scope","Recipe","ProductRepository","RecipeRepository","CurrentRecipe",function(a,b,c,d,e){function f(){if(a.videoUrl){var b=new RegExp("[?&]v(=([^&#]*)|&|#|$)"),c=b.exec(a.videoUrl);return c?c[2]?decodeURIComponent(c[2].replace(/\+/g," ")):"":null}}function g(){return a.tags.trim().split(",")}a.recipe=e.get(),a.addProduct=function(){a.selectedProduct||alert("Selecione um produto."),console.log(a.recipe.products),"-1"!=a.selectedProduct?c.find(a.selectedProduct).then(function(b){a.recipe.products.push(b)},function(a){alert("Houve um erro na obtenção do produto selecionado")}):(a.recipe.products.push({name:a.newProductName,short_desc:a.newProductDesc}),a.newProductName="",a.selectedProduct="",a.newProductDesc="")},a.insertImageStep=function(){var b={type:"image"};a.recipe.steps.push(b)},a.insertMomentStep=function(){var b={type:"moment"};a.recipe.steps.push(b)},a.moveStep=function(b,c){var d=a.recipe.steps[c];a.recipe.steps[c]=a.recipe.steps[b],a.recipe.steps[b]=d},a.removeStep=function(b){a.recipe.steps.splice(b,1)},a.create=function(){if(a.recipe.has_video){var b=f();if(!b||""===b)return alert("Url não informada ou incorreta.");a.recipe.video_id=b}return a.recipe.tags=g(),a.recipe.tags.length>10?alert("Número de tags acima do limite definido."):void d.sendForApproval(a.recipe).then(function(a){alert(a)},function(a){alert("Houve um erro no envio da receita.")})},c.groupByCategory().then(function(b){a.categories=b},function(a){alert("Erro ao obter a lista de produtos agrupados por categoria")})}]),Bebella.directive("fileread",[function(){return{scope:{fileread:"="},link:function(a,b,c){b.bind("change",function(b){var c=new FileReader;c.onload=function(b){a.$apply(function(){a.fileread=b.target.result})},c.readAsDataURL(b.target.files[0])})}}}]),Bebella.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/dashboard/profile"),a.state("recipes",{url:"/recipe/list",views:{Content:{controller:"RecipeListCtrl",templateUrl:view("recipe/list")}}}).state("new_recipe",{url:"/recipe/new",views:{Content:{controller:"RecipeNewCtrl",templateUrl:view("recipe/new")}}}).state("dashboard",{url:"/dashboard",views:{Content:{controller:"HomeIndexCtrl",templateUrl:view("dashboard")}}}).state("dashboard.profile",{url:"/profile",views:{SubContent:{controller:"ProfileIndexCtrl",templateUrl:view("profile")}}}).state("dashboard.stats",{url:"/stats",views:{SubContent:{controller:"StatsIndexCtrl",templateUrl:view("stats")}}})}]);